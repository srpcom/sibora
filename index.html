<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIBORA - Sistem Booking Ruangan</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="https://github.com/srpcom/bookingruangan/blob/main/logo%20rsud%202025%20tansparent2.png?raw=true" type="image/png">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca;
            --glass-bg: rgba(255, 255, 255, 0.85); /* Default glass for dashboard */
            --glass-border: rgba(255, 255, 255, 0.9);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --text-main: #1f2937;
            --bg-gradient: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        body { 
            font-family: 'Inter', sans-serif; margin: 0; padding: 0; min-height: 100vh;
            color: var(--text-main); background-color: #f3f4f6;
            background: var(--bg-gradient);
            background-attachment: fixed; background-size: cover; background-position: center;
        }

        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .hidden { display: none !important; }

        /* Typography */
        h1, h2, h3, h4 { font-family: 'Poppins', sans-serif; margin: 0; color: #1e1b4b; }
        
        /* Glass Card (Global) */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px; border: 1px solid var(--glass-border);
            padding: 2.5rem; box-shadow: var(--card-shadow); margin-bottom: 2rem;
        }

        /* Buttons */
        .btn { 
            padding: 0.7rem 1.5rem; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 600; transition: all 0.2s; display: inline-block;
        }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-icon { background: transparent; padding: 5px; color: var(--primary); font-size: 1.1rem; }
        .btn-icon:hover { color: var(--primary-hover); transform: scale(1.1); }
        
        /* Admin Action Buttons on Card */
        .admin-controls-overlay {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 6px; z-index: 10;
        }
        .btn-mini {
            width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; text-decoration: none; font-size: 1rem; transition: all 0.2s; border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-mini:hover { transform: scale(1.1); }
        
        .btn-del { background: #fee2e2; color: #ef4444; }
        .btn-del:hover { background: #ef4444; color: white; }
        
        .btn-wa { background: #dcfce7; color: #16a34a; }
        .btn-wa:hover { background: #16a34a; color: white; }

        /* Form Elements */
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 0.9rem; border-radius: 12px; border: 1px solid #d1d5db;
            background: rgba(255,255,255,0.8); font-size: 1rem; box-sizing: border-box; transition: all 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); background: white; }
        .form-control:read-only { background: #e5e7eb; color: #6b7280; cursor: not-allowed; }

        /* --- LOGIN SCREEN REDESIGN (Beautiful Glass) --- */
        .login-wrapper {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            flex-direction: column; text-align: center; padding: 20px;
            position: relative; overflow: hidden; /* For decoration */
        }
        
        /* Decorative Blobs for Glass Effect */
        .login-bg-decoration {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; pointer-events: none;
        }
        .blob {
            position: absolute; filter: blur(50px); opacity: 0.6;
        }
        .blob-1 {
            top: 20%; left: 20%; width: 300px; height: 300px;
            background: #a78bfa; border-radius: 50%;
            animation: moveBlob 8s infinite alternate;
        }
        .blob-2 {
            bottom: 20%; right: 20%; width: 250px; height: 250px;
            background: #f472b6; border-radius: 50%;
            animation: moveBlob 10s infinite alternate-reverse;
        }
        @keyframes moveBlob { from { transform: translate(0, 0); } to { transform: translate(20px, -20px); } }

        .login-card { 
            max-width: 400px; width: 100%; 
            padding: 3.5rem 2rem; 
            background: rgba(255, 255, 255, 0.2); /* Sangat transparan */
            backdrop-filter: blur(20px); /* Blur kuat */
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6); /* Border es */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border-radius: 28px;
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .login-logo { width: 100px; margin-bottom: 1.5rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); transition: transform 0.3s; }
        .login-logo:hover { transform: scale(1.05); }
        
        .login-title { 
            font-size: 2.2rem; font-weight: 800; color: #1e1b4b; 
            margin-bottom: 0.5rem; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(255,255,255,0.5);
        }
        .login-subtitle { 
            font-size: 0.95rem; color: #4b5563; margin-bottom: 2.5rem; 
            font-weight: 500; opacity: 0.9;
        }
        
        .login-footer { margin-top: 2.5rem; font-size: 0.75rem; color: #6b7280; font-weight: 500; opacity: 0.8; }

        /* Header & Nav */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;}
        .user-info { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.6); padding: 5px 15px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(5px); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Schedule & Admin List */
        .booking-item, .admin-item {
            background: white; padding: 1.25rem; border-radius: 16px; margin-bottom: 1rem;
            border-left: 5px solid #ccc; transition: all 0.2s; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; border-left-width: 5px;
        }
        .booking-item:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.06); }
        
        /* Status Colors */
        .status-disetujui { border-left-color: #10b981; background: linear-gradient(to right, #ecfdf5, #fff); }
        .status-belum-disetujui { border-left-color: #f59e0b; background: linear-gradient(to right, #fffbeb, #fff); }
        .status-ditolak { border-left-color: #ef4444; background: linear-gradient(to right, #fef2f2, #fff); }

        /* Tables */
        .table-responsive { overflow-x: auto; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 0; background: white; overflow: hidden; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #f3f4f6; }
        th { background: #f9fafb; color: var(--text-main); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }

    </style>
</head>
<body>

    <!-- 1. VIEW: LOGIN SCREEN (REDESIGNED) -->
    <div id="view-login" class="login-wrapper">
        <!-- Background Ornaments -->
        <div class="login-bg-decoration">
            <div class="blob blob-1"></div>
            <div class="blob blob-2"></div>
        </div>

        <div class="glass-card login-card">
            <img src="https://github.com/srpcom/bookingruangan/blob/main/logo%20rsud%202025%20tansparent2.png?raw=true" class="login-logo" alt="Logo RSUD">
            
            <!-- Judul Diperbarui -->
            <h1 class="login-title">SIBORA</h1>
            <p class="login-subtitle">Sistem Booking Ruangan<br>RSUD dr. R. Koesma Tuban</p>
            
            <div style="display: flex; justify-content: center; margin-bottom: 1rem; width: 100%;">
                <div id="g_id_onload"
                     data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="pill"
                     data-theme="filled_blue"
                     data-text="signin_with"
                     data-size="large"
                     data-logo_alignment="center"
                     data-width="280">
                </div>
            </div>
            
            <p id="login-msg" style="margin-top: 15px; font-size: 0.85rem; color: #ef4444; min-height: 20px;"></p>
            
            <div class="login-footer">
                &copy; 2025 RSUD dr. R. Koesma Tuban.<br>All rights reserved.
            </div>
        </div>
    </div>

    <!-- 2. VIEW: SETUP PROFIL (NEW USER) -->
    <div id="view-setup" class="container hidden" style="margin-top: 5vh;">
        <div class="glass-card" style="max-width: 550px; margin: auto; padding: 3rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="https://github.com/srpcom/bookingruangan/blob/main/logo%20rsud%202025%20tansparent2.png?raw=true" style="width: 70px; margin-bottom: 1rem;">
                <h2 style="font-weight: 700; color: var(--primary);">Lengkapi Profil Anda</h2>
                <p class="text-muted">Mohon lengkapi data diri Anda untuk melanjutkan.</p>
            </div>
            <form onsubmit="handleSaveProfile(event, 'setup')">
                <div class="form-group">
                    <label>Email (Google)</label>
                    <input type="text" id="setup-email" class="form-control" readonly style="background-color: #f3f4f6;">
                </div>
                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="setup-nama" class="form-control" required placeholder="Contoh: dr. Budi Santoso">
                </div>
                <div class="form-group">
                    <label>Unit / Bagian</label>
                    <input type="text" id="setup-unit" class="form-control" required placeholder="Contoh: Instalasi Farmasi">
                </div>
                <div class="form-group">
                    <label>Nomor WhatsApp (Aktif)</label>
                    <input type="tel" id="setup-wa" class="form-control" required placeholder="081234567890">
                    <small style="color: #6b7280; font-size: 0.8rem; margin-top: 0.25rem; display: block;">*Notifikasi status booking akan dikirim ke nomor ini.</small>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-4" style="padding: 1rem;">Simpan & Lanjutkan <i class="fas fa-arrow-right ms-2"></i></button>
            </form>
        </div>
    </div>

    <!-- 3. VIEW: MAIN APP (DASHBOARD) -->
    <div id="view-dashboard" class="container hidden">
        <header class="app-header">
            <div style="display: flex; align-items: center;">
                <img src="https://github.com/srpcom/bookingruangan/blob/main/logo%20rsud%202025%20tansparent2.png?raw=true" style="height: 60px; margin-right: 15px;" alt="Logo">
                <div>
                    <h1>SIBORA</h1>
                    <p style="opacity: 0.8; margin: 0;">RSUD dr. R. Koesma Tuban</p>
                </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="user-info">
                    <img id="head-avatar" src="" class="user-avatar">
                    <div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span id="head-nama" style="font-weight: 600; font-size: 0.9rem;">User</span>
                            <button onclick="showEditProfile()" class="btn-icon" title="Edit Profil">‚úèÔ∏è</button>
                        </div>
                        <div id="head-role" style="font-size: 0.75rem; color: #666;">USER</div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-sm">Keluar</button>
            </div>
        </header>

        <!-- ADMIN PANEL (Hidden for normal users) -->
        <div id="admin-panel" class="hidden mb-4">
            <div class="glass-card" style="background: rgba(255,255,255,0.95); border-left: 5px solid var(--primary);">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>üëë Admin Dashboard</h3>
                    <div class="d-flex gap-2">
                        <button onclick="showUserMgmt()" class="btn btn-secondary">üë• Manajemen User</button>
                        <button onclick="showSettings()" class="btn btn-secondary">‚öôÔ∏è Pengaturan</button>
                        <button onclick="handleDeleteOldData()" class="btn btn-danger">üóëÔ∏è Hapus Data Lama</button>
                    </div>
                </div>
                <hr>
                <h4>Persetujuan Booking</h4>
                <div id="admin-approval-list">
                    <p class="text-center">Memuat daftar...</p>
                </div>
            </div>
        </div>

        <!-- USER PANEL (Booking Form) -->
        <div class="glass-card">
            <h3>üìÖ Buat Booking Baru</h3>
            <form onsubmit="handleBookingSubmit(event)" class="mt-4">
                <div class="row" style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Nama Peminjam</label>
                        <input type="text" id="book-nama" class="form-control" readonly>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Unit / Bagian</label>
                        <input type="text" id="book-unit" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Pilih Ruangan</label>
                    <select id="book-ruangan" class="form-control" required>
                        <option value="">Memuat ruangan...</option>
                    </select>
                </div>

                <div class="row" style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Mulai</label>
                        <input type="datetime-local" id="book-mulai" class="form-control" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Selesai (Default: +60 Menit)</label>
                        <input type="datetime-local" id="book-selesai" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Keperluan</label>
                    <textarea id="book-keperluan" class="form-control" rows="3" required placeholder="Contoh: Rapat Evaluasi Bulanan"></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100">Kirim Pengajuan</button>
            </form>
        </div>

        <!-- SCHEDULE MONITOR -->
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>üñ•Ô∏è Monitor Jadwal</h3>
                <button onclick="fetchData()" class="btn btn-secondary">Refresh</button>
            </div>
            <div id="schedule-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <p>Memuat jadwal...</p>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyRSj_mjQ15k0W_5C640ft3QCsCrhjTSM4Pl9jG1pW6Hw3vMTj0DVSmgh4JeALWUw/exec';
        
        let currentUser = null;
        let rooms = [];
        let bookings = [];

        // --- UTILS: COMPRESS IMAGE FUNCTION ---
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Output compressed data URL
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // Helper to Base64 (Fallback if compression not needed for small files)
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- AUTH LOGIC ---
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            const email = responsePayload.email;
            const photo = responsePayload.picture;
            const name = responsePayload.name;

            document.getElementById('login-msg').innerText = "Memeriksa akun...";
            
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'google_login', email: email, name: name, photo: photo })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    // Login Berhasil
                    sessionStorage.setItem('sibora_user', JSON.stringify(data.user));
                    initApp();
                } else if (data.status === 'new_user') {
                    // Harus isi profil
                    showSetupProfile(data.email, name, photo);
                } else {
                    document.getElementById('login-msg').innerText = "Gagal Login: " + data.message;
                }
            })
            .catch(err => document.getElementById('login-msg').innerText = "Koneksi Error.");
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function showSetupProfile(email, name, photo) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-setup').classList.remove('hidden');
            document.getElementById('setup-email').value = email;
            document.getElementById('setup-nama').value = name;
            // Simpan foto sementara di session
            sessionStorage.setItem('temp_photo', photo);
        }

        // --- EDIT PROFILE LOGIC (WITH COMPRESSION) ---
        function showEditProfile() {
            Swal.fire({
                title: '‚úèÔ∏è Edit Profil',
                html: `
                    <div style="text-align: left; margin-top: 10px;">
                        <label style="font-weight:600; font-size:0.9rem;">Email (Tidak dapat diubah)</label>
                        <input id="edit-email" class="form-control mb-2" value="${currentUser.email}" readonly style="background-color:#e9ecef;">
                        
                        <label style="font-weight:600; font-size:0.9rem;">Nama Lengkap</label>
                        <input id="edit-nama" class="form-control mb-2" value="${currentUser.nama}">
                        
                        <label style="font-weight:600; font-size:0.9rem;">Unit / Bagian</label>
                        <input id="edit-unit" class="form-control mb-2" value="${currentUser.unit}">
                        
                        <label style="font-weight:600; font-size:0.9rem;">Nomor WhatsApp</label>
                        <input id="edit-wa" class="form-control mb-2" value="${currentUser.wa}">

                        <label style="font-weight:600; font-size:0.9rem;">Ganti Foto Profil (Opsional)</label>
                        <input type="file" id="edit-foto" class="form-control mb-2" accept="image/*">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Simpan Perubahan',
                confirmButtonColor: '#4f46e5',
                showLoaderOnConfirm: true,
                preConfirm: async () => {
                    const nama = document.getElementById('edit-nama').value;
                    const unit = document.getElementById('edit-unit').value;
                    const wa = document.getElementById('edit-wa').value;
                    const fileInput = document.getElementById('edit-foto').files[0];
                    
                    if(!nama || !unit || !wa) {
                        Swal.showValidationMessage('Semua field harus diisi');
                        return false;
                    }

                    // Handle Photo Upload with Compression
                    let newPhotoUrl = currentUser.foto;
                    if (fileInput) {
                        try {
                            // COMPRESS IMAGE HERE (Max Width 800px, Quality 70%)
                            const compressedBase64 = await compressImage(fileInput, 800, 0.7);
                            
                            const uploadRes = await fetch(GAS_URL, {
                                method: 'POST',
                                body: JSON.stringify({
                                    action: 'upload_foto',
                                    email: currentUser.email,
                                    // Remove 'data:image/jpeg;base64,' prefix before sending
                                    base64: compressedBase64.split(',')[1],
                                    mimeType: 'image/jpeg' 
                                })
                            }).then(r => r.json());

                            if (uploadRes.status === 'success') {
                                newPhotoUrl = uploadRes.url;
                            } else {
                                Swal.showValidationMessage('Gagal upload foto: ' + uploadRes.message);
                                return false;
                            }
                        } catch (e) {
                            Swal.showValidationMessage('Error processing image: ' + e.toString());
                            return false;
                        }
                    }

                    return fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'save_profile',
                            email: currentUser.email,
                            nama: nama,
                            unit: unit,
                            wa: wa,
                            foto: newPhotoUrl
                        })
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    })
                    .catch(error => Swal.showValidationMessage(`Request failed: ${error}`));
                }
            }).then((result) => {
                if (result.isConfirmed && result.value.status === 'success') {
                    // Update Local Session
                    currentUser = result.value.user;
                    sessionStorage.setItem('sibora_user', JSON.stringify(currentUser));
                    
                    // Update UI
                    document.getElementById('head-nama').innerText = currentUser.nama;
                    document.getElementById('book-nama').value = currentUser.nama;
                    document.getElementById('book-unit').value = currentUser.unit;
                    document.getElementById('head-avatar').src = currentUser.foto;
                    
                    Swal.fire('Berhasil', 'Profil berhasil diperbarui.', 'success');
                } else if (result.isConfirmed) {
                    Swal.fire('Gagal', result.value.message || 'Terjadi kesalahan', 'error');
                }
            });
        }

        // Handle Setup Awal (New User)
        function handleSaveProfile(e, mode) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.textContent = "Menyimpan..."; btn.disabled = true;

            const payload = {
                action: 'save_profile',
                email: document.getElementById('setup-email').value,
                nama: document.getElementById('setup-nama').value,
                unit: document.getElementById('setup-unit').value,
                wa: document.getElementById('setup-wa').value,
                foto: sessionStorage.getItem('temp_photo') || ""
            };

            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    sessionStorage.setItem('sibora_user', JSON.stringify(data.user));
                    initApp();
                } else {
                    Swal.fire('Error', 'Gagal menyimpan profil', 'error');
                    btn.textContent = "Simpan & Lanjutkan"; btn.disabled = false;
                }
            });
        }

        function initApp() {
            const userStr = sessionStorage.getItem('sibora_user');
            if (!userStr) {
                document.getElementById('view-login').classList.remove('hidden');
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-setup').classList.add('hidden');
                return;
            }

            currentUser = JSON.parse(userStr);
            
            // Tampilkan Dashboard
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-setup').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');

            // Set Header Info
            document.getElementById('head-nama').innerText = currentUser.nama;
            document.getElementById('head-role').innerText = currentUser.role;
            document.getElementById('head-avatar').src = currentUser.foto || "https://via.placeholder.com/40";

            // Pre-fill Booking Form
            document.getElementById('book-nama').value = currentUser.nama;
            document.getElementById('book-unit').value = currentUser.unit;
            
            // --- SET DEFAULT TIME ---
            setDefaultBookingTime();

            // Show Admin Panel if Role is ADMIN
            if (currentUser.role === 'ADMIN') {
                document.getElementById('admin-panel').classList.remove('hidden');
            }

            fetchData();
        }
        
        // --- FUNGSI WAKTU DEFAULT ---
        function setDefaultBookingTime() {
            const now = new Date();
            // Start: Now + 1 hour
            const start = new Date(now.getTime() + 60 * 60 * 1000); 
            // End: Start + 60 minutes
            const end = new Date(start.getTime() + 60 * 60 * 1000);

            const formatDateTime = (date) => {
                // Adjust for local timezone manual to avoid UTC confusion
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };

            document.getElementById('book-mulai').value = formatDateTime(start);
            document.getElementById('book-selesai').value = formatDateTime(end);
        }

        function logout() {
            sessionStorage.clear();
            location.reload();
        }

        // --- HELPER FORMAT TANGGAL ---
        function formatDateToID(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }

        // --- DATA & BOOKING LOGIC ---
        
        async function fetchData() {
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                
                if (data.status === 'success') {
                    rooms = data.rooms;
                    bookings = data.data;
                    
                    // Render Room Options
                    const select = document.getElementById('book-ruangan');
                    // Simpan value saat ini jika ada (agar tidak reset saat refresh otomatis)
                    const currentVal = select.value;
                    select.innerHTML = '';
                    
                    // Add default option
                    const defOpt = document.createElement('option');
                    defOpt.value = ""; defOpt.innerText = "Pilih Ruangan...";
                    select.appendChild(defOpt);

                    rooms.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r; opt.innerText = r;
                        select.appendChild(opt);
                    });
                    
                    if(currentVal) select.value = currentVal;

                    // Render Schedule
                    renderSchedule();

                    // Render Admin Approval (If Admin)
                    if (currentUser.role === 'ADMIN') renderAdminApproval();

                    // Apply Background
                    if (data.background) {
                        document.body.style.backgroundImage = `url('${data.background}')`;
                    }
                }
            } catch (e) { console.error(e); }
        }

        function handleBookingSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.textContent = "Mengirim..."; btn.disabled = true;

            const payload = {
                action: 'booking', // Default action in backend logic
                email: currentUser.email, // Send Email to verify user
                namaRuangan: document.getElementById('book-ruangan').value,
                tanggalMulai: document.getElementById('book-mulai').value.split('T')[0],
                waktuMulai: document.getElementById('book-mulai').value.split('T')[1],
                tanggalSelesai: document.getElementById('book-selesai').value.split('T')[0],
                waktuSelesai: document.getElementById('book-selesai').value.split('T')[1],
                keperluan: document.getElementById('book-keperluan').value
            };

            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire('Berhasil', 'Pengajuan dikirim. Cek notifikasi Email/WA.', 'success');
                    e.target.reset();
                    // Reset field readonly
                    document.getElementById('book-nama').value = currentUser.nama; 
                    document.getElementById('book-unit').value = currentUser.unit;
                    // Reset waktu default
                    setDefaultBookingTime();
                    fetchData();
                } else {
                    Swal.fire('Gagal', data.message, 'error');
                }
                btn.textContent = "Kirim Pengajuan"; btn.disabled = false;
            });
        }

        // --- RENDER FUNCTIONS ---

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            
            // Filter Active Bookings
            const visible = bookings.filter(b => b.Status !== 'Ditolak');
            visible.sort((a,b) => new Date(a['Tanggal Mulai']+'T'+a['Waktu Mulai']) - new Date(b['Tanggal Mulai']+'T'+b['Waktu Mulai']));

            rooms.forEach(room => {
                const col = document.createElement('div');
                col.className = 'booking-item'; // Reusing style class for container look
                col.style.borderLeft = 'none';
                col.innerHTML = `<h4 style="border-bottom:1px solid #eee; padding-bottom:10px; text-align:center; color:var(--primary);">${room}</h4>`;
                
                const roomBookings = visible.filter(b => b['Nama Ruangan'] === room);
                
                if (roomBookings.length === 0) {
                    col.innerHTML += `<p style="text-align:center; opacity:0.5; font-size:0.9rem;">Tidak ada jadwal.</p>`;
                } else {
                    roomBookings.forEach(b => {
                        const statusClass = `status-${b.Status.toLowerCase().replace(/ /g, '-')}`;
                        const div = document.createElement('div');
                        div.className = `booking-item ${statusClass}`;
                        div.style.marginBottom = '10px';
                        
                        // MOVE STATUS LOGIC UP TO BE USED IN WA MSG
                        let statusColor = '#f59e0b'; // Default Pending
                        let statusIcon = '‚è≥';
                        if (b.Status === 'Disetujui') { statusColor = '#10b981'; statusIcon = '‚úÖ'; }
                        else if (b.Status === 'Ditolak') { statusColor = '#ef4444'; statusIcon = '‚ùå'; }

                        let adminControls = '';
                        if (currentUser.role === 'ADMIN') {
                            // WA Logic
                            let waLink = '#';
                            let waStyle = 'opacity:0.5; cursor:not-allowed;';
                            let waTitle = 'No WA tidak tersedia';
                            
                            if (b['Nomor WA']) {
                                let rawNum = b['Nomor WA'].toString().replace(/[^0-9]/g, '');
                                if (rawNum.startsWith('0')) rawNum = '62' + rawNum.substring(1);
                                
                                // NEW FORMATTED MESSAGE
                                const msg = `Halo *${b['Nama Peminjam']}*,\n\nInformasi Booking Ruangan:\n\nüè¢ Ruang: *${b['Nama Ruangan']}*\nüóìÔ∏è Tanggal: *${formatDateToID(b['Tanggal Mulai'])}\nüïí Waktu: *${b['Waktu Mulai']} - ${b['Waktu Selesai']}*\nüìã Acara: *${b.Keperluan}*\n\nStatus: ${statusIcon} *${b.Status.toUpperCase()}*\n\nTerima kasih.`;
                                
                                waLink = `https://wa.me/${rawNum}?text=${encodeURIComponent(msg)}`;
                                waStyle = '';
                                waTitle = 'Kirim Detail via WA';
                            }

                            adminControls = `
                                <div class="admin-controls-overlay">
                                    <a href="${waLink}" target="_blank" class="btn-mini btn-wa" style="${waStyle}" title="${waTitle}">üí¨</a>
                                    <button class="btn-mini btn-del" onclick="deleteBooking('${b['ID Booking']}')" title="Hapus Permanen">üóëÔ∏è</button>
                                </div>
                            `;
                        }

                        div.innerHTML = `
                            ${adminControls}
                            <div style="font-weight:bold; font-size:1rem; padding-right:25px; margin-bottom: 5px;">${b.Keperluan}</div>
                            <div style="font-size:0.9rem; color:#555; margin-bottom: 8px;">
                                üë§ <b>${b['Nama Peminjam']}</b><br>
                                <span style="font-size:0.85rem; opacity:0.8;">(${b['Unit/Bagian']})</span>
                            </div>
                            <div style="background:#f9fafb; padding:8px; border-radius:8px; font-size:0.85rem;">
                                üïí ${formatDateToID(b['Tanggal Mulai'])} ${b['Waktu Mulai']} <br>
                                üèÅ ${formatDateToID(b['Tanggal Selesai'])} ${b['Waktu Selesai']}
                            </div>
                            <div style="text-align:right; font-size:0.85rem; font-weight:bold; margin-top:8px; color:${statusColor};">
                                ${statusIcon} ${b.Status.toUpperCase()}
                            </div>
                        `;
                        col.appendChild(div);
                    });
                }
                container.appendChild(col);
            });
        }

        function renderAdminApproval() {
            const l = document.getElementById('admin-approval-list');
            const p = bookings.filter(b => b.Status === 'Belum Disetujui');
            
            if (p.length === 0) {
                l.innerHTML = '<p class="text-center text-muted">Tidak ada pengajuan pending.</p>';
                return;
            }

            l.innerHTML = '';
            p.forEach(b => {
                const div = document.createElement('div');
                div.className = 'booking-item status-belum-disetujui';
                
                const tglMulai = formatDateToID(b['Tanggal Mulai']);
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <h4>${b.Keperluan}</h4>
                            <p><b>${b['Nama Peminjam']}</b> (${b['Unit/Bagian']}) - WA: ${b['Nomor WA']}</p>
                            <p>üè† Ruang: <b>${b['Nama Ruangan']}</b></p>
                            <p>‚è∞ ${tglMulai} ${b['Waktu Mulai']} s.d ${b['Waktu Selesai']}</p>
                        </div>
                        <div>
                            <button onclick="updateStatus('${b['ID Booking']}', 'Disetujui')" class="btn btn-primary btn-sm mb-1 w-100">‚úÖ Setujui</button><br>
                            <button onclick="updateStatus('${b['ID Booking']}', 'Ditolak')" class="btn btn-danger btn-sm w-100">‚ùå Tolak</button>
                        </div>
                    </div>
                `;
                l.appendChild(div);
            });
        }

        async function updateStatus(id, status) {
            let reason = "";
            if (status === 'Ditolak') {
                const { value: text, isDismissed } = await Swal.fire({
                    input: 'textarea',
                    inputLabel: 'Alasan Penolakan',
                    inputPlaceholder: 'Tuliskan alasan penolakan di sini...',
                    inputAttributes: { 'aria-label': 'Tulis alasan penolakan' },
                    showCancelButton: true,
                    confirmButtonText: 'Kirim Penolakan',
                    cancelButtonText: 'Batal',
                    confirmButtonColor: '#d33'
                });
                if (isDismissed) return;
                if (!text) { Swal.fire('Error', 'Alasan harus diisi', 'warning'); return; }
                reason = text;
            } else {
                const c = await Swal.fire({ title: 'Setujui Pengajuan?', icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Setujui' });
                if (!c.isConfirmed) return;
            }

            Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading() });
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateStatus', bookingId: id, newStatus: status, reason: reason })
            })
            .then(res => res.json())
            .then(data => {
                Swal.fire('Sukses', data.message, 'success');
                fetchData();
            });
        }

        // --- ADMIN: USER MANAGEMENT ---
        function showUserMgmt() {
            Swal.fire({
                title: 'Manajemen User',
                html: '<div id="user-list-container">Memuat data user...</div>',
                width: '800px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_users' }) })
                    .then(res => res.json())
                    .then(data => {
                        if(data.status === 'success') {
                            let html = `<div class="table-responsive"><table><thead><tr><th>Nama</th><th>Email</th><th>Unit</th><th>Role</th><th>Aksi</th></tr></thead><tbody>`;
                            data.users.forEach(u => {
                                let btnAction = '';
                                if(u.role === 'ADMIN') {
                                    btnAction = `<button onclick="changeRole('${u.email}', 'USER')" class="btn btn-warning btn-sm" style="font-size:0.7rem">Jadi User</button>`;
                                } else {
                                    btnAction = `<button onclick="changeRole('${u.email}', 'ADMIN')" class="btn btn-primary btn-sm" style="font-size:0.7rem">Jadi Admin</button>`;
                                }
                                html += `<tr>
                                    <td>${u.nama}</td>
                                    <td style="font-size:0.85rem">${u.email}</td>
                                    <td>${u.unit}</td>
                                    <td><b>${u.role}</b></td>
                                    <td>${btnAction}</td>
                                </tr>`;
                            });
                            html += `</tbody></table></div>`;
                            document.getElementById('user-list-container').innerHTML = html;
                        } else {
                            document.getElementById('user-list-container').innerText = "Gagal memuat data.";
                        }
                    });
                }
            });
        }

        window.changeRole = function(email, newRole) {
            Swal.fire({
                title: `Ubah role ${email}?`,
                text: `Menjadi ${newRole}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Ubah'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'update_user_role', targetEmail: email, newRole: newRole })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.status === 'success') {
                            Swal.fire('Sukses', data.message, 'success');
                            showUserMgmt(); // Reload modal content
                        } else {
                            Swal.fire('Gagal', data.message, 'error');
                        }
                    });
                }
            });
        };

        // --- ADMIN: SETTINGS ---
        function showSettings() {
            Swal.fire({
                title: 'Pengaturan Aplikasi',
                html: `
                    <div style="text-align:left">
                        <label>Ganti Background (URL)</label>
                        <input id="set-bg" class="form-control mb-2" placeholder="https://...">
                        <button onclick="saveBg()" class="btn btn-primary btn-sm w-100">Simpan Background</button>
                        <hr>
                        <label>Tambah Ruangan</label>
                        <input id="set-room" class="form-control mb-2" placeholder="Nama Ruangan">
                        <button onclick="addRoom()" class="btn btn-success btn-sm w-100">Tambah Ruangan</button>
                    </div>
                `,
                showConfirmButton: false
            });
        }

        window.saveBg = function() {
            const url = document.getElementById('set-bg').value;
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'saveBackground', url: url, password: 'lia' }) }) 
            .then(() => { Swal.fire('Sukses','Background disimpan','success'); fetchData(); });
        }

        window.addRoom = function() {
            const name = document.getElementById('set-room').value;
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'addRoom', roomName: name, password: 'lia' }) })
            .then(() => { Swal.fire('Sukses','Ruangan ditambah','success'); fetchData(); });
        }

        function handleDeleteOldData() {
            Swal.fire({ title: 'Hapus Data Lama?', text: 'Data lampau akan dihapus permanen', icon: 'warning', showCancelButton: true, confirmButtonText: 'Hapus' })
            .then(res => {
                if(res.isConfirmed) {
                    fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteOldBookings', password: 'lia' }) })
                    .then(r=>r.json()).then(d => Swal.fire('Info', d.message, 'info').then(()=>fetchData()));
                }
            });
        }
        
        async function deleteBooking(id) {
            const c = await Swal.fire({ 
                title: 'Hapus Permanen?', 
                text: "Data ini akan dihapus dari database dan tidak bisa dikembalikan.", 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonColor: '#d33', 
                confirmButtonText: 'Ya, Hapus' 
            });
            
            if (c.isConfirmed) {
                Swal.fire({ title: 'Menghapus...', didOpen: () => Swal.showLoading() });
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteBooking', bookingId: id })
                }).then(r => r.json()).then(d => {
                    if(d.status === 'success') { Swal.fire('Terhapus', d.message, 'success'); fetchData(); }
                    else { Swal.fire('Gagal', d.message, 'error'); }
                });
            }
        }

        // Initialize
        initApp();

    </script>
</body>
</html>
