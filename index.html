<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Ruang Rapat - RSUD dr. R. Koesma</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --iron-red: #c82a1d; --iron-gold: #f8d452; --arc-blue: #00b8ff;
            --status-approved: #28a745; --status-pending: #ffc107; --status-rejected: #6c757d;
            --bg-dark: #101419; --bg-admin: #1a1a2e; --text-light: #f0f0f0;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 1rem; min-height: 100vh; color: var(--text-light); transition: background-color: 0.5s; }
        .user-view-bg { background: linear-gradient(rgba(16, 20, 25, 0.85), rgba(16, 20, 25, 0.85)), url('https://raw.githubusercontent.com/srpcom/bookingruangan/main/photo_2025-07-11_16-49-46.jpg'); background-size: cover; background-position: center; background-attachment: fixed; }
        .admin-view-bg { background-color: var(--bg-admin); }
        .container { max-width: 1200px; margin: auto; padding: 0; }
        header { text-align: center; margin-bottom: 2rem; }
        header h1 { font-size: 2rem; color: var(--iron-gold); margin: 0; }
        .user-content { display: flex; flex-direction: column; gap: 2rem; }
        .glass-card { background: rgba(20, 30, 40, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.15); padding: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--iron-red); padding-bottom: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;}
        .card-header h2 { color: var(--iron-gold); margin: 0; font-size: 1.5rem; border: none; padding: 0; }
        .btn-refresh { background: transparent; border: 1px solid var(--arc-blue); color: var(--arc-blue); padding: 0.4rem 0.8rem; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
        .btn-refresh:hover { background: var(--arc-blue); color: white; }
        .booking-item { background: rgba(10, 20, 30, 0.5); padding: 0.75rem; border-radius: 5px; margin-bottom: 0.75rem; font-size: 0.9rem; }
        .booking-item.status-disetujui { border-left: 4px solid var(--status-approved); }
        .booking-item.status-belum-disetujui { border-left: 4px solid var(--status-pending); }
        .booking-item.status-ditolak { border-left: 4px solid var(--status-rejected); background: rgba(40,20,20,0.5); }
        .booking-item .status { font-weight: bold; text-align: right; margin-top: 5px; }
        .status-disetujui .status { color: var(--status-approved); }
        .status-belum-disetujui .status { color: var(--status-pending); }
        .status-ditolak .status { color: var(--status-rejected); }
        .schedule-rooms { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .room-column { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 1rem; }
        .room-column h3 { margin-top: 0; color: var(--arc-blue); text-align: center; }
        #admin-section { display: none; }
        .admin-booking-item { background: #16213e; margin-bottom: 1rem; padding: 1rem; border-radius: 8px; border-left: 5px solid var(--status-pending); }
        .admin-booking-item[data-status="Disetujui"] { border-color: var(--status-approved); }
        .admin-booking-item[data-status="Ditolak"] { border-color: var(--status-rejected); background: #2a2a3e; opacity: 0.7; }
        .actions { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-approve { background-color: var(--status-approved); color: white; }
        .btn-reject { background-color: #ffc107; color: black; }
        .btn-delete { background-color: var(--iron-red); color: white; }
        .btn-settings { background-color: var(--arc-blue); color: white; }
        .login-form { max-width: 400px; margin: 5rem auto; padding: 2rem; background: #16213e; border-radius: 8px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background-color: rgba(0,0,0,0.3); color: var(--text-light); font-size: 1rem; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 0.8rem 1rem; font-size: 1.1rem; font-weight: 700; color: var(--text-light); background: linear-gradient(45deg, var(--iron-red), #a01010); border: none; border-radius: 8px; cursor: pointer; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #16213e; padding: 2rem; border-radius: 10px; text-align: center; max-width: 90%; width: 400px; border-top: 4px solid var(--arc-blue); }
        .modal-content.error { border-top-color: var(--iron-red); }
        .modal-buttons { margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem; }
        
        /* Room Settings Styles */
        .room-list-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; margin-bottom: 0.5rem; border-radius: 5px; }
        .room-list-item span { font-weight: 500; }
        .btn-icon { background: none; border: none; cursor: pointer; color: var(--iron-red); font-size: 1.2rem; }
        
        @media (min-width: 992px) { .user-content { display: grid; grid-template-columns: 400px 1fr; gap: 2rem; } .schedule-rooms { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- User View -->
        <div id="user-section">
            <header><h1>Sistem Booking Ruang Rapat</h1><p>RSUD dr. R. Koesma Tuban</p></header>
            <div class="user-content">
                <div class="form-card glass-card">
                    <div class="card-header"><h2>Buat Booking Baru</h2></div>
                    <form id="bookingForm"></form>
                </div>
                <div class="schedule-card glass-card">
                    <div class="card-header">
                        <h2>Jadwal Penggunaan Ruangan</h2>
                        <button id="refreshUserBtn" class="btn-refresh">‚Üª Refresh</button>
                    </div>
                    <div id="scheduleContainer" class="schedule-rooms"><p id="loadingMessage">Memuat jadwal...</p></div>
                </div>
            </div>
        </div>
        <!-- Admin View -->
        <div id="admin-section">
            <header><h1>Halaman Admin Approval</h1></header>
            <div id="admin-login-view" class="login-form">
                <h2>Login Admin</h2>
                <div class="form-group"><label for="adminPassword">Password</label><input type="password" id="adminPassword" placeholder="Masukkan password admin"></div>
                <button id="adminLoginBtn" class="btn-submit">Lihat Data</button>
                <p id="login-message" style="color: red; text-align: center; margin-top: 1rem;"></p>
            </div>
            <div id="admin-dashboard-view" style="display: none;">
                <!-- Daftar Pengajuan (Approval List) -->
                <div class="card-header">
                    <h2>Daftar Pengajuan</h2>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button id="roomSettingsBtn" class="btn btn-settings">‚öôÔ∏è Ruangan</button>
                        <button id="deleteOldDataBtn" class="btn btn-delete">Hapus Data Lama</button>
                        <button id="refreshAdminBtn" class="btn-refresh">‚Üª Refresh</button>
                    </div>
                </div>
                <ul id="booking-list" style="list-style: none; padding: 0; margin-bottom: 3rem;"></ul>

                <!-- Monitor Jadwal Ruangan (Visual Schedule for Admin) -->
                <div class="card-header" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <h2>Monitor Jadwal Ruangan</h2>
                </div>
                <div id="adminScheduleContainer" class="schedule-rooms">
                    <p>Memuat jadwal...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Umum -->
    <div id="modal" class="modal-overlay">
        <div id="modalContent" class="modal-content">
            <h3 id="modalTitle" style="margin-top:0; color:var(--arc-blue);">Pemberitahuan</h3>
            <div id="modalBody"></div>
            <div id="modalButtons" class="modal-buttons"></div>
        </div>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyRSj_mjQ15k0W_5C640ft3QCsCrhjTSM4Pl9jG1pW6Hw3vMTj0DVSmgh4JeALWUw/exec';
        // Variabel global 'rooms' tidak lagi hardcoded, akan diisi dari server
        let rooms = []; 
        
        // Elemen DOM
        const userSection = document.getElementById('user-section');
        const adminSection = document.getElementById('admin-section');
        const scheduleContainer = document.getElementById('scheduleContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const bookingForm = document.getElementById('bookingForm');
        
        // Elemen Admin
        const adminLoginView = document.getElementById('admin-login-view');
        const adminDashboardView = document.getElementById('admin-dashboard-view');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminPasswordInput = document.getElementById('adminPassword');
        const bookingList = document.getElementById('booking-list');
        const adminScheduleContainer = document.getElementById('adminScheduleContainer');
        const loginMessage = document.getElementById('login-message');
        
        // Tombol
        const refreshUserBtn = document.getElementById('refreshUserBtn');
        const refreshAdminBtn = document.getElementById('refreshAdminBtn');
        const deleteOldDataBtn = document.getElementById('deleteOldDataBtn');
        const roomSettingsBtn = document.getElementById('roomSettingsBtn');
        
        // Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalButtons = document.getElementById('modalButtons');
        const modalContent = document.getElementById('modalContent');
        
        let currentAdminPassword = '';

        // --- Modal Functions ---
        const showModal = (message, type = 'info', title = 'Pemberitahuan') => {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            modalContent.className = `modal-content ${type}`;
            modalButtons.innerHTML = `<button class="btn btn-submit">OK</button>`;
            modal.style.display = 'flex';
            modalButtons.querySelector('button').onclick = () => modal.style.display = 'none';
        };

        const showConfirm = (message) => {
            return new Promise(resolve => {
                modalTitle.textContent = 'Konfirmasi';
                modalBody.textContent = message;
                modalContent.className = 'modal-content';
                modalButtons.innerHTML = `<button id="confirm-yes" class="btn btn-delete">Ya</button><button id="confirm-no" class="btn">Tidak</button>`;
                modal.style.display = 'flex';
                document.getElementById('confirm-yes').onclick = () => { modal.style.display = 'none'; resolve(true); };
                document.getElementById('confirm-no').onclick = () => { modal.style.display = 'none'; resolve(false); };
            });
        };
        
        // --- Room Settings Modal ---
        const showRoomSettings = () => {
            modalTitle.textContent = 'Pengaturan Ruangan';
            modalContent.className = 'modal-content';
            
            // Build List HTML
            let listHtml = '<div style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem; text-align: left;">';
            rooms.forEach(r => {
                listHtml += `<div class="room-list-item">
                    <span>${r}</span>
                    <button onclick="handleDeleteRoom('${r}')" class="btn-icon" title="Hapus">üóëÔ∏è</button>
                </div>`;
            });
            listHtml += '</div>';
            
            // Add Form HTML
            listHtml += `<div style="display: flex; gap: 0.5rem;">
                <input type="text" id="newRoomName" placeholder="Nama Ruangan Baru" style="flex:1; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; color: black;">
                <button onclick="handleAddRoom()" class="btn btn-submit" style="width: auto;">+</button>
            </div>`;
            
            modalBody.innerHTML = listHtml;
            modalButtons.innerHTML = `<button onclick="document.getElementById('modal').style.display='none'" class="btn">Tutup</button>`;
            modal.style.display = 'flex';
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.hash === '#admin') { showAdminView(); } else { showUserView(); }
            window.addEventListener('hashchange', () => { if (window.location.hash === '#admin') { showAdminView(); } else { window.location.reload(); } });
        });
        
        roomSettingsBtn.addEventListener('click', showRoomSettings);

        // --- Logic User View ---
        function showUserView() {
            document.body.className = 'user-view-bg';
            userSection.style.display = 'block';
            adminSection.style.display = 'none';
            
            // Form render awal (Select masih kosong / loading)
            bookingForm.innerHTML = `<div class="form-group"><label for="namaRuangan">Pilih Ruangan</label><select id="namaRuangan" name="namaRuangan" required><option value="">Memuat data ruangan...</option></select></div><div class="form-group"><label for="namaPeminjam">Nama Peminjam</label><input type="text" id="namaPeminjam" name="namaPeminjam" required></div><div class="form-group"><label for="unitBagianSelect">Unit / Bagian</label><select id="unitBagianSelect" name="unitBagianSelect" required><option value="">-- Pilih Unit / Bagian --</option><option value="Bagian Administrasi dan Umum">Bagian Administrasi dan Umum</option><option value="Bagian Keuangan">Bagian Keuangan</option><option value="Bagian Program dan Pelaporan">Bagian Program dan Pelaporan</option><option value="Bidang Pelayanan Medik">Bidang Pelayanan Medik</option><option value="Bidang Keperawatan">Bidang Keperawatan</option><option value="Bidang Pelayanan Penunjang">Bidang Pelayanan Penunjang</option><option value="Lainnya">Lainnya</option></select></div><div class="form-group" id="unitBagianLainnyaContainer" style="display: none;"><label for="unitBagianLainnya">Sebutkan Unit / Bagian Lainnya</label><input type="text" id="unitBagianLainnya" name="unitBagianLainnya"></div><div class="form-group"><label for="nomorWa">Nomor WA (Opsional)</label><input type="tel" id="nomorWa" name="nomorWa" placeholder="Contoh: 0812-3456-7890" inputmode="tel"></div><div class="form-group"><label for="tanggalMulai">Tanggal & Waktu Mulai</label><input type="datetime-local" id="tanggalMulai" name="tanggalMulai" required></div><div class="form-group"><label for="tanggalSelesai">Tanggal & Waktu Selesai</label><input type="datetime-local" id="tanggalSelesai" name="tanggalSelesai" required></div><div class="form-group"><label for="keperluan">Keperluan</label><textarea id="keperluan" name="keperluan" required></textarea></div><button type="submit" class="btn-submit" id="submitButton">Kirim Permintaan Booking</button>`;
            
            const unitBagianSelect = document.getElementById('unitBagianSelect');
            const unitBagianLainnyaContainer = document.getElementById('unitBagianLainnyaContainer');
            const unitBagianLainnyaInput = document.getElementById('unitBagianLainnya');

            unitBagianSelect.addEventListener('change', () => {
                if (unitBagianSelect.value === 'Lainnya') {
                    unitBagianLainnyaContainer.style.display = 'block';
                    unitBagianLainnyaInput.required = true;
                } else {
                    unitBagianLainnyaContainer.style.display = 'none';
                    unitBagianLainnyaInput.required = false;
                    unitBagianLainnyaInput.value = '';
                }
            });
            
            // Set waktu default
            const tanggalMulaiInput = document.getElementById('tanggalMulai');
            const tanggalSelesaiInput = document.getElementById('tanggalSelesai');
            const timezoneOffset = (new Date()).getTimezoneOffset() * 60000;
            const now = new Date(Date.now() - timezoneOffset);
            const end = new Date(now.getTime() + 60 * 60 * 1000);
            tanggalMulaiInput.value = now.toISOString().slice(0, 16);
            tanggalMulaiInput.min = now.toISOString().slice(0, 16);
            tanggalSelesaiInput.value = end.toISOString().slice(0, 16);
            
            if (!bookingForm.hasSubmitListener) {
                bookingForm.addEventListener('submit', handleUserSubmit);
                bookingForm.hasSubmitListener = true;
            }
            refreshUserBtn.addEventListener('click', fetchUserSchedule);
            fetchUserSchedule();
        }

        async function fetchUserSchedule() {
            loadingMessage.textContent = 'Memuat jadwal & ruangan...';
            loadingMessage.style.display = 'block';
            scheduleContainer.innerHTML = '';
            try {
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) throw new Error('Respon jaringan tidak baik.');
                const result = await response.json();
                if (result.status === 'success') { 
                    // 1. Update Data Ruangan Global
                    rooms = result.rooms || []; 
                    
                    // 2. Update Dropdown di Form
                    updateRoomDropdown();
                    
                    // 3. Render Jadwal
                    renderUserSchedule(result.data); 
                } 
                else { throw new Error(result.message); }
            } catch (error) {
                scheduleContainer.innerHTML = `<p style="color:var(--iron-red);">Gagal memuat data. Error: ${error.message}</p>`;
            } finally {
                loadingMessage.style.display = 'none';
            }
        }
        
        function updateRoomDropdown() {
            const select = document.getElementById('namaRuangan');
            if(select) {
                select.innerHTML = '';
                rooms.forEach(r => {
                   const opt = document.createElement('option');
                   opt.value = r;
                   opt.textContent = r;
                   select.appendChild(opt);
                });
            }
        }

        function renderUserSchedule(data) {
            scheduleContainer.innerHTML = '';
            const visibleBookings = data.filter(b => b.Status === "Disetujui" || b.Status === "Belum Disetujui" || b.Status === "Ditolak");
            visibleBookings.sort((a, b) => new Date(`${a['Tanggal Mulai']}T${a['Waktu Mulai']}`) - new Date(`${b['Tanggal Mulai']}T${b['Waktu Mulai']}`));
            
            // Loop berdasarkan ruangan dinamis
            rooms.forEach(room => {
                const roomColumn = document.createElement('div');
                roomColumn.className = 'room-column';
                roomColumn.innerHTML = `<h3>${room}</h3>`;
                const bookingsForRoom = visibleBookings.filter(b => b['Nama Ruangan'] === room);
                if (bookingsForRoom.length === 0) {
                    roomColumn.innerHTML += '<p style="opacity:0.6; text-align:center;">Belum ada jadwal.</p>';
                } else {
                    bookingsForRoom.forEach(booking => {
                        const item = document.createElement('div');
                        const statusClass = `status-${booking.Status.toLowerCase().replace(/ /g, '-')}`;
                        item.className = `booking-item ${statusClass}`;
                        const startDate = new Date(`${booking['Tanggal Mulai']}T${booking['Waktu Mulai']}`);
                        const endDate = new Date(`${booking['Tanggal Selesai']}T${booking['Waktu Selesai']}`);
                        const statusText = booking.Status === 'Ditolak' ? 'TIDAK DISETUJUI' : booking.Status;
                        item.innerHTML = `<p class="keperluan">${booking.Keperluan}</p><p class="peminjam">Oleh: ${booking['Nama Peminjam']} (${booking['Unit/Bagian']})</p><p><strong>Mulai:</strong> ${startDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })} ${booking['Waktu Mulai']}</p><p><strong>Selesai:</strong> ${endDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })} ${booking['Waktu Selesai']}</p><p class="status">${statusText}</p>`;
                        roomColumn.appendChild(item);
                    });
                }
                scheduleContainer.appendChild(roomColumn);
            });
        }
        
        async function handleUserSubmit(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submitButton');
            // ... (logika validasi waktu sama seperti sebelumnya) ...
            const startDateTime = new Date(document.getElementById('tanggalMulai').value);
            const endDateTime = new Date(document.getElementById('tanggalSelesai').value);
            const now = new Date(); now.setSeconds(0,0);
             if (startDateTime < now) { showModal('Waktu mulai tidak valid.', 'error'); return; }
             if (endDateTime <= startDateTime) { showModal('Waktu selesai harus setelah waktu mulai.', 'error'); return; }

            submitButton.disabled = true; submitButton.textContent = 'Mengirim...';
            const formData = new FormData(bookingForm);
            let unitBagian = formData.get('unitBagianSelect') === 'Lainnya' ? formData.get('unitBagianLainnya') : formData.get('unitBagianSelect');

            const bookingData = { 
                namaRuangan: formData.get('namaRuangan'), 
                namaPeminjam: formData.get('namaPeminjam'), 
                unitBagian: unitBagian, 
                nomorWa: formData.get('nomorWa'),
                tanggalMulai: startDateTime.toISOString().split('T')[0], 
                waktuMulai: startDateTime.toTimeString().split(' ')[0].substring(0,5), 
                tanggalSelesai: endDateTime.toISOString().split('T')[0], 
                waktuSelesai: endDateTime.toTimeString().split(' ')[0].substring(0,5), 
                keperluan: formData.get('keperluan'), 
            };
            try {
                const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify(bookingData), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                const result = await response.json();
                if (result.status === 'success') { 
                    showModal(result.message); 
                    bookingForm.reset();
                    fetchUserSchedule();
                } else { showModal(result.message, 'error'); }
            } catch (error) { showModal('Gagal mengirim booking.', 'error'); } 
            finally { submitButton.disabled = false; submitButton.textContent = 'Kirim Permintaan Booking'; }
        }

        // --- Logic Admin View ---
        function showAdminView() {
            document.body.className = 'admin-view-bg';
            userSection.style.display = 'none';
            adminSection.style.display = 'block';
            adminLoginBtn.addEventListener('click', handleAdminLogin);
            adminPasswordInput.addEventListener('keyup', e => e.key === 'Enter' && handleAdminLogin());
            refreshAdminBtn.addEventListener('click', fetchAdminData);
            deleteOldDataBtn.addEventListener('click', handleDeleteOldData);
        }
        
        async function fetchAdminData() {
            bookingList.innerHTML = '<p>Memuat data terbaru...</p>';
            adminScheduleContainer.innerHTML = '<p>Memuat jadwal ruangan...</p>'; 
            try {
                const dataResponse = await fetch(GAS_WEB_APP_URL);
                const dataResult = await dataResponse.json();
                if (dataResult.status !== 'success') throw new Error(dataResult.message);
                
                rooms = dataResult.rooms || []; // Update rooms saat admin refresh
                renderAdminList(dataResult.data);
                renderAdminSchedule(dataResult.data);
            } catch (error) {
                bookingList.innerHTML = `<p style="color:red">Gagal: ${error.message}</p>`;
                adminScheduleContainer.innerHTML = '';
            }
        }

        // Render Jadwal di Dashboard Admin
        function renderAdminSchedule(data) {
            adminScheduleContainer.innerHTML = '';
            // Admin melihat status Disetujui & Belum Disetujui
            const visibleBookings = data.filter(b => b.Status === "Disetujui" || b.Status === "Belum Disetujui");
            visibleBookings.sort((a, b) => new Date(`${a['Tanggal Mulai']}T${a['Waktu Mulai']}`) - new Date(`${b['Tanggal Mulai']}T${b['Waktu Mulai']}`));
            
            rooms.forEach(room => {
                const roomColumn = document.createElement('div');
                roomColumn.className = 'room-column';
                roomColumn.innerHTML = `<h3>${room}</h3>`;
                const bookingsForRoom = visibleBookings.filter(b => b['Nama Ruangan'] === room);
                if (bookingsForRoom.length === 0) {
                    roomColumn.innerHTML += '<p style="opacity:0.6; text-align:center; font-size:0.8rem">Kosong</p>';
                } else {
                    bookingsForRoom.forEach(booking => {
                        const item = document.createElement('div');
                        const statusClass = `status-${booking.Status.toLowerCase().replace(/ /g, '-')}`;
                        item.className = `booking-item ${statusClass}`;
                        const startDate = new Date(`${booking['Tanggal Mulai']}T${booking['Waktu Mulai']}`);
                        item.innerHTML = `<p class="keperluan" style="font-weight:bold">${booking.Keperluan}</p><p style="font-size:0.8rem">${startDate.toLocaleDateString('id-ID', {day:'numeric', month:'short'})}, ${booking['Waktu Mulai']}</p><p class="status" style="font-size:0.75rem">${booking.Status}</p>`;
                        roomColumn.appendChild(item);
                    });
                }
                adminScheduleContainer.appendChild(roomColumn);
            });
        }
        
        // --- Logic Manajemen Ruangan (Add/Delete) ---
        async function handleAddRoom() {
            const input = document.getElementById('newRoomName');
            const roomName = input.value.trim();
            if (!roomName) return;
            
            // UI Feedback (sementara)
            const oldText = input.value;
            input.value = "Menyimpan...";
            input.disabled = true;

            const payload = { action: 'addRoom', password: currentAdminPassword, roomName: roomName };
            try {
                const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if(result.status === 'success') {
                    rooms.push(roomName); // Update lokal biar cepat
                    showRoomSettings(); // Refresh modal
                    fetchAdminData(); // Refresh background
                } else {
                    alert(result.message);
                }
            } catch(e) { alert("Gagal koneksi"); }
            finally { input.value = ""; input.disabled = false; }
        }

        async function handleDeleteRoom(roomName) {
            if(!confirm(`Yakin hapus ruangan "${roomName}"?`)) return;
            
            // Tutup modal loading
            modalBody.innerHTML = '<p>Menghapus...</p>';
            
            const payload = { action: 'deleteRoom', password: currentAdminPassword, roomName: roomName };
            try {
                const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if(result.status === 'success') {
                    rooms = rooms.filter(r => r !== roomName); // Update lokal
                    showRoomSettings(); // Buka lagi modalnya
                    fetchAdminData();
                } else {
                    alert(result.message);
                    showRoomSettings();
                }
            } catch(e) { alert("Gagal koneksi"); showRoomSettings(); }
        }

        async function handleAdminLogin() {
            loginMessage.textContent = "Validasi...";
            adminLoginBtn.disabled = true;
            currentAdminPassword = adminPasswordInput.value;
            if (!currentAdminPassword) { loginMessage.textContent = "Password kosong."; adminLoginBtn.disabled = false; return; }
            try {
                const validationResponse = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'validatePassword', password: currentAdminPassword }) });
                const validationResult = await validationResponse.json();
                if (validationResult.status !== 'success') throw new Error(validationResult.message);
                adminLoginView.style.display = 'none';
                adminDashboardView.style.display = 'block';
                await fetchAdminData();
            } catch (error) { loginMessage.textContent = `Gagal: ${error.message}`; } 
            finally { adminLoginBtn.disabled = false; }
        }
        
        // Render List Approval (Logic lama dipertahankan)
        function renderAdminList(data) {
            bookingList.innerHTML = '';
            data.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            if (data.length === 0) { bookingList.innerHTML = '<p style="text-align: center; opacity: 0.7;">Tidak ada data.</p>'; return; }
            data.forEach(booking => {
                const item = document.createElement('li');
                item.className = 'admin-booking-item';
                item.dataset.status = booking.Status;
                const actionsHtml = booking.Status === 'Belum Disetujui' 
                    ? `<div class="actions"><button class="btn btn-approve" data-id="${booking['ID Booking']}" data-status="Disetujui">Setujui</button><button class="btn btn-reject" data-id="${booking['ID Booking']}" data-status="Ditolak">Tolak</button><button class="btn btn-delete" data-id="${booking['ID Booking']}">Hapus</button></div>`
                    : `<div class="actions"><button class="btn btn-delete" data-id="${booking['ID Booking']}">Hapus</button></div>`;
                
                item.innerHTML = `<div class="item-header"><h3>${booking.Keperluan}</h3><span class="status">${booking.Status}</span></div><p><strong>Ruang:</strong> ${booking['Nama Ruangan']}</p><p><strong>Oleh:</strong> ${booking['Nama Peminjam']}</p><p><strong>Waktu:</strong> ${booking['Tanggal Mulai']} ${booking['Waktu Mulai']}</p>${actionsHtml}`;
                bookingList.appendChild(item);
            });
            bookingList.addEventListener('click', handleAdminAction);
        }

        // Logic Delete Old Data
        async function handleDeleteOldData() {
            const confirmed = await showConfirm('Hapus semua data booking lampau?');
            if (!confirmed) return;
            const btn = deleteOldDataBtn; btn.disabled = true; btn.textContent = 'Menghapus...';
            try {
                const res = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteOldBookings', password: currentAdminPassword }) });
                const json = await res.json();
                showModal(json.message); fetchAdminData();
            } catch(e) { showModal('Gagal', 'error'); } finally { btn.disabled = false; btn.textContent = 'Hapus Data Lama'; }
        }
        
        // Logic Admin Action (Approve/Reject/Delete)
        async function handleAdminAction(e) {
            if(!e.target.matches('button')) return;
            const btn = e.target;
            const action = btn.classList.contains('btn-delete') ? 'deleteBooking' : 'updateStatus';
            const payload = { action: action, password: currentAdminPassword, bookingId: btn.dataset.id };
            if(action === 'updateStatus') payload.newStatus = btn.dataset.status;
            
            if(action === 'deleteBooking' && !(await showConfirm('Hapus permanen?'))) return;

            btn.disabled = true; btn.textContent = '...';
            try {
                const res = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.status === 'success') { showModal(json.message); fetchAdminData(); }
                else { throw new Error(json.message); }
            } catch(err) { showModal(err.message, 'error'); btn.disabled=false; }
        }
    </script>
</body>
</html>
